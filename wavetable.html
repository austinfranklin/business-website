<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Oscilloscope Drawing Synth</title>
<style>
  body {
    font-family: sans-serif;
    background: #111;
    color: #fff;
    text-align: center;
    padding: 2rem;
  }
  h1 {
    color: #0ff;
  }
  canvas {
    background: #000;
    border: 2px solid #0ff;
    border-radius: 5px;
    display: block;
    margin: 1rem auto;
    touch-action: none;
  }
  button {
    background: transparent;
    border: 1px solid #0ff;
    color: #0ff;
    padding: 0.5rem 1rem;
    margin: 0.5rem;
    font-size: 1rem;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.3s, color 0.3s;
  }
  button:hover {
    background: #0ff;
    color: #111;
  }
</style>
</head>
<body>

<h1>Oscilloscope Drawing Synth</h1>
<canvas id="drawCanvas" width="512" height="512"></canvas>
<div>
  <button id="playBtn">Play</button>
  <button id="stopBtn">Stop</button>
  <button id="clearBtn">Clear</button>
</div>

<script>
(() => {
  const canvas = document.getElementById('drawCanvas');
  const ctx = canvas.getContext('2d');
  let drawing = false;
  let points = [];
  let audioCtx = null;
  let bufferSource = null;

  // Draw only the new segment
  function drawLineSegment(p1, p2) {
    ctx.strokeStyle = "#0ff";
    ctx.beginPath();
    ctx.moveTo(p1.x, p1.y);
    ctx.lineTo(p2.x, p2.y);
    ctx.stroke();
  }

  function startDrawing(e) {
    drawing = true;
    addPoint(e);
  }

  function drawMove(e) {
    if (!drawing) return;
    const prev = points[points.length - 1];
    const newPt = addPoint(e);
    drawLineSegment(prev, newPt);
  }

  function stopDrawing() {
    drawing = false;
  }

  function addPoint(e) {
    const rect = canvas.getBoundingClientRect();
    const clientX = e.clientX !== undefined ? e.clientX : e.touches[0].clientX;
    const clientY = e.clientY !== undefined ? e.clientY : e.touches[0].clientY;
    const x = clientX - rect.left;
    const y = clientY - rect.top;
    const pt = { x, y };
    points.push(pt);
    return pt;
  }

  function playDrawing() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    stopDrawingPlayback();

    if (points.length < 2) return;

    const sampleCount = 44100; // 1 sec
    const leftData = new Float32Array(sampleCount);
    const rightData = new Float32Array(sampleCount);

    for (let i = 0; i < sampleCount; i++) {
      const t = i / sampleCount;
      const idx = Math.floor(t * (points.length - 1));
      const p = points[idx];
      leftData[i] = (p.x / canvas.width) * 2 - 1;  // X -> Left
      rightData[i] = (p.y / canvas.height) * 2 - 1; // Y -> Right
    }

    // Apply short fade-in/fade-out envelope to avoid click
    const fadeSamples = Math.floor(sampleCount * 0.01); // ~10 ms at 44.1kHz
    for (let i = 0; i < fadeSamples; i++) {
      const fadeInGain = i / fadeSamples;
      const fadeOutGain = (fadeSamples - i) / fadeSamples;
      leftData[i] *= fadeInGain;
      rightData[i] *= fadeInGain;
      leftData[sampleCount - 1 - i] *= fadeOutGain;
      rightData[sampleCount - 1 - i] *= fadeOutGain;
    }

    const buffer = audioCtx.createBuffer(2, sampleCount, audioCtx.sampleRate);
    buffer.copyToChannel(leftData, 0);
    buffer.copyToChannel(rightData, 1);

    bufferSource = audioCtx.createBufferSource();
    bufferSource.buffer = buffer;
    bufferSource.loop = true;
    bufferSource.connect(audioCtx.destination);
    bufferSource.start();
  }

  function stopDrawingPlayback() {
    if (bufferSource) {
      bufferSource.stop();
      bufferSource.disconnect();
      bufferSource = null;
    }
  }

  function clearDrawing() {
    points = [];
    ctx.fillStyle = "#000";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }

  // Mouse + touch events
  canvas.addEventListener('mousedown', startDrawing);
  canvas.addEventListener('mousemove', drawMove);
  window.addEventListener('mouseup', stopDrawing);

  canvas.addEventListener('touchstart', startDrawing);
  canvas.addEventListener('touchmove', drawMove);
  window.addEventListener('touchend', stopDrawing);

  document.getElementById('playBtn').addEventListener('click', playDrawing);
  document.getElementById('stopBtn').addEventListener('click', stopDrawingPlayback);
  document.getElementById('clearBtn').addEventListener('click', clearDrawing);

  // Initial fill
  clearDrawing();
})();
</script>

</body>
</html>
